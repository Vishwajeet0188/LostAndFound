<% layout("layouts/boilerplate") %>

<div class="edit-item-page">
  <div class="container">
    <div class="edit-item-card">

      <h2>Edit Item</h2>

      <!-- Back Button -->
      <a href="/items/<%= item._id %>" class="btn btn-outline-secondary mb-4">
        <i class="fas fa-arrow-left me-1"></i> Back to Item Details
      </a>

      <form action="/items/<%= item._id %>?_method=PUT" method="POST" enctype="multipart/form-data" class="row g-3" id="editForm">

        <!-- TITLE -->
        <div class="col-12">
          <label class="form-label required">Item Name</label>
          <input type="text" name="title" value="<%= item.title %>" class="form-control" required>
        </div>

        <!-- DESCRIPTION -->
        <div class="col-12">
          <label class="form-label required">Description</label>
          <textarea name="description" class="form-control" rows="5" required><%= item.description %></textarea>
        </div>

        <!-- LOCATION -->
        <div class="col-12">
          <label class="form-label required">Location</label>
          <input type="text" name="location" value="<%= item.location %>" class="form-control" required>
        </div>

        <!-- CATEGORY -->
        <div class="col-12">
          <label class="form-label required">Category</label>
          <select name="category" class="form-select" required>
            <option value="">Select a category</option>
            <option value="Electronics" <%= item.category === 'Electronics' ? 'selected' : '' %>>Electronics</option>
            <option value="Documents" <%= item.category === 'Documents' ? 'selected' : '' %>>Documents</option>
            <option value="Jewelry" <%= item.category === 'Jewelry' ? 'selected' : '' %>>Jewelry</option>
            <option value="Clothing" <%= item.category === 'Clothing' ? 'selected' : '' %>>Clothing</option>
            <option value="Keys" <%= item.category === 'Keys' ? 'selected' : '' %>>Keys</option>
            <option value="Wallet" <%= item.category === 'Wallet' ? 'selected' : '' %>>Wallet/Purse</option>
            <option value="Books" <%= item.category === 'Books' ? 'selected' : '' %>>Books</option>
            <option value="Accessories" <%= item.category === 'Accessories' ? 'selected' : '' %>>Accessories</option>
            <option value="Other" <%= item.category === 'Other' ? 'selected' : '' %>>Other</option>
          </select>
        </div>

        <!-- REWARD -->
        <div class="col-12">
          <label class="form-label">Reward (₹)</label>
          <div class="input-group">
            <span class="input-group-text">₹</span>
            <input type="number" name="reward" value="<%= item.reward %>" class="form-control" min="0" step="100">
          </div>
          <small class="text-muted">Leave 0 or empty for no reward</small>
        </div>

        <!-- CURRENT IMAGE -->
        <div class="col-12">
          <label class="form-label">Current Image</label>
          <% if (item.image) { %>
            <div class="current-image mb-3">
              <img 
                src="<%= item.image %>" 
                alt="Current Item Image"
                class="img-thumbnail"
                style="max-width: 200px; max-height: 200px; object-fit: cover;"
                onerror="this.style.display='none'; document.getElementById('no-image').style.display='block';"
              >
              <div id="no-image" class="alert alert-secondary mt-2" style="display:none;">
                <i class="fas fa-exclamation-circle me-2"></i>
                Current image could not be loaded
              </div>
            </div>
          <% } else { %>
            <div class="alert alert-info">
              <i class="fas fa-image me-2"></i> No image uploaded for this item
            </div>
          <% } %>
        </div>

        <!-- UPLOAD NEW IMAGE -->
        <div class="col-12">
          <label class="form-label">Upload New Image (Optional)</label>
          <input 
            type="file" 
            name="image" 
            class="form-control"
            accept="image/*"
            id="imageUpload"
          >
          <small class="text-muted">Only JPG, PNG, WebP images allowed (max 5MB)</small>
          
          <!-- Image Preview -->
          <div class="image-preview mt-3" id="imagePreview" style="display: none;">
            <p class="small text-muted mb-2">Preview:</p>
            <img id="previewImage" class="img-thumbnail" style="max-width: 200px; max-height: 200px; object-fit: cover;">
          </div>
        </div>

        <!-- CONTACT INFORMATION -->
        <div class="col-12 mt-4">
          <h5 class="border-bottom pb-2 mb-3">Contact Information</h5>
        </div>

        <div class="col-md-6">
          <label class="form-label">Contact Name</label>
          <input type="text" name="contactName" value="<%= item.contactName || user.name %>" class="form-control">
        </div>

        <div class="col-md-6">
          <label class="form-label">Contact Phone</label>
          <input type="text" name="contactPhone" value="<%= item.contactPhone %>" class="form-control" placeholder="Optional">
        </div>

        <div class="col-12">
          <label class="form-label">Contact Email</label>
          <input type="email" name="contactEmail" value="<%= item.contactEmail || user.email %>" class="form-control">
        </div>

        <!-- SUBMIT BUTTONS -->
        <div class="col-12 mt-4 d-flex gap-3">
          <button type="submit" class="btn btn-primary flex-grow-1">
            <i class="fas fa-save me-2"></i> Save Changes
          </button>
          <a href="/items/<%= item._id %>" class="btn btn-outline-secondary">
            <i class="fas fa-times me-2"></i> Cancel
          </a>
        </div>

      </form>

    </div>
  </div>
</div>

<style>
  .edit-item-page {
    min-height: 100vh;
    padding: 40px 0;
    background: linear-gradient(135deg, #f5f7fa, #c3cfe2);
  }

  /* Form card */
  .edit-item-card {
    background: #ffffff;
    border-radius: 16px;
    padding: 30px;
    box-shadow: 0 15px 40px rgba(0, 0, 0, 0.12);
    animation: slideFade 0.6s ease;
    max-width: 800px;
    margin: 0 auto;
  }

  /* Page title */
  .edit-item-card h2 {
    text-align: center;
    font-weight: 700;
    margin-bottom: 25px;
    color: #2c3e50;
    border-bottom: 3px solid #3498db;
    padding-bottom: 15px;
  }

  /* Labels */
  .edit-item-card .form-label {
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 8px;
  }

  /* Required field indicator */
  .required::after {
    content: " *";
    color: #dc3545;
  }

  /* Inputs & textarea */
  .edit-item-card .form-control,
  .edit-item-card .form-select {
    border-radius: 10px;
    padding: 12px 15px;
    border: 1px solid #ddd;
    transition: all 0.25s ease;
    background: #f8f9fa;
  }

  .edit-item-card .form-control:focus,
  .edit-item-card .form-select:focus {
    border-color: #4facfe;
    box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.25);
    background: white;
  }

  /* Textarea */
  .edit-item-card textarea {
    resize: vertical;
    min-height: 120px;
  }

  /* Current image */
  .current-image img {
    border-radius: 10px;
    border: 2px solid #dee2e6;
    transition: transform 0.3s ease;
  }

  .current-image img:hover {
    transform: scale(1.05);
  }

  /* Image preview */
  .image-preview {
    margin-top: 10px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 10px;
    border: 2px dashed #dee2e6;
  }

  .image-preview img {
    width: 100%;
    max-height: 220px;
    object-fit: contain;
    border-radius: 8px;
  }

  /* Submit button */
  .edit-item-card .btn-primary {
    border-radius: 10px;
    padding: 12px 24px;
    font-weight: 600;
    background: linear-gradient(135deg, #667eea, #764ba2);
    border: none;
    transition: transform 0.25s ease, box-shadow 0.25s ease;
  }

  .edit-item-card .btn-primary:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 25px rgba(102, 126, 234, 0.45);
  }

  .edit-item-card .btn-outline-secondary {
    border-radius: 10px;
    padding: 12px 24px;
    font-weight: 600;
    border: 2px solid #6c757d;
  }

  .edit-item-card .btn-outline-secondary:hover {
    background: #6c757d;
    color: white;
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(108, 117, 125, 0.3);
  }

  /* Section headers */
  .edit-item-card h5 {
    color: #2c3e50;
    font-weight: 600;
  }

  /* Animation */
  @keyframes slideFade {
    from {
      opacity: 0;
      transform: translateY(25px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Mobile */
  @media (max-width: 576px) {
    .edit-item-card {
      padding: 20px;
    }
    
    .edit-item-card .btn {
      width: 100%;
      margin-bottom: 10px;
    }
    
    .edit-item-card .d-flex {
      flex-direction: column;
    }
  }

  /* Alert styles */
  .alert {
    border-radius: 10px;
    border: none;
  }

  /* Validation styles */
  .is-invalid {
    border-color: #dc3545 !important;
  }

  .is-invalid:focus {
    box-shadow: 0 0 0 0.25rem rgba(220, 53, 69, 0.25) !important;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('editForm');
    const imageUpload = document.getElementById('imageUpload');
    const imagePreview = document.getElementById('imagePreview');
    const previewImage = document.getElementById('previewImage');
    
    // Image upload preview
    if (imageUpload) {
      imageUpload.addEventListener('change', function() {
        const file = this.files[0];
        
        if (file) {
          // Validate file size (max 5MB)
          if (file.size > 5 * 1024 * 1024) {
            alert('File size must be less than 5MB');
            this.value = '';
            imagePreview.style.display = 'none';
            return;
          }
          
          // Validate file type
          const allowedTypes = ['image/jpeg', 'image/png', 'image/webp', 'image/gif'];
          if (!allowedTypes.includes(file.type)) {
            alert('Only JPG, PNG, WebP, and GIF images are allowed');
            this.value = '';
            imagePreview.style.display = 'none';
            return;
          }
          
          // Show preview
          const reader = new FileReader();
          reader.onload = function(e) {
            previewImage.src = e.target.result;
            imagePreview.style.display = 'block';
          }
          reader.readAsDataURL(file);
        } else {
          imagePreview.style.display = 'none';
        }
      });
    }
    
    // Form validation
    if (form) {
      form.addEventListener('submit', function(e) {
        // Clear previous invalid states
        const invalidFields = form.querySelectorAll('.is-invalid');
        invalidFields.forEach(field => {
          field.classList.remove('is-invalid');
        });
        
        // Check required fields
        const requiredFields = form.querySelectorAll('[required]');
        let isValid = true;
        
        requiredFields.forEach(field => {
          if (!field.value.trim()) {
            isValid = false;
            field.classList.add('is-invalid');
            
            // Scroll to first invalid field
            if (isValid === false) {
              field.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
          }
        });
        
        if (!isValid) {
          e.preventDefault();
          alert('Please fill in all required fields (marked with *)');
        }
      });
    }
  });



  // Auto-suggest category when description changes
document.getElementById('description').addEventListener('blur', async function() {
  const text = this.value;
  if (text.length > 10) { // Only call if there's enough text
    const categorySelect = document.getElementById('category'); // Your existing category select
    
    try {
      const response = await fetch('/api/ai/suggest-category', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ description: text })
      });
      
      const data = await response.json();
      if (data.suggestedCategory) {
        // Find and select the suggested category
        for (let option of categorySelect.options) {
          if (option.text.toLowerCase() === data.suggestedCategory.toLowerCase()) {
            option.selected = true;
            
            // Show suggestion
            const suggestionDiv = document.createElement('div');
            suggestionDiv.className = 'alert alert-info alert-dismissible fade show mt-2';
            suggestionDiv.innerHTML = `
              <i class="fas fa-lightbulb"></i> AI suggested category: <strong>${data.suggestedCategory}</strong>
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            categorySelect.parentNode.appendChild(suggestionDiv);
            break;
          }
        }
      }
    } catch (error) {
      console.error('Category suggestion error:', error);
      // Fail silently - don't bother user
    }
  }
});




</script>