<% layout("layouts/boilerplate") %>

<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-md-10">
      <div class="card shadow">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
          <h4 class="mb-0">Manage Reward for <%= item.title %></h4>
          <span class="badge bg-<%= item.rewardPaymentStatus === 'paid' ? 'success' : 'warning' %>">
            <%= item.rewardPaymentStatus.toUpperCase() %>
          </span>
        </div>
        <div class="card-body">
          
          <!-- Status Indicators -->
          <div class="row mb-4">
            <div class="col-md-12">
              <div class="steps">
                <div class="step <%= ['pending', 'requested', 'approved', 'paid', 'confirmed'].includes(item.rewardPaymentStatus) ? 'completed' : '' %>">
                  <div class="step-circle">1</div>
                  <div class="step-label">Reward Claimed</div>
                </div>
                <div class="step <%= ['approved', 'paid', 'confirmed'].includes(item.rewardPaymentStatus) ? 'completed' : '' %>">
                  <div class="step-circle">2</div>
                  <div class="step-label">Owner Approved</div>
                </div>
                <div class="step <%= ['paid', 'confirmed'].includes(item.rewardPaymentStatus) ? 'completed' : '' %>">
                  <div class="step-circle">3</div>
                  <div class="step-label">Payment Sent</div>
                </div>
                <div class="step <%= item.rewardPaymentStatus === 'confirmed' ? 'completed' : '' %>">
                  <div class="step-circle">4</div>
                  <div class="step-label">Payment Confirmed</div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Claim Information -->
          <div class="row mb-4">
            <div class="col-md-6">
              <div class="card">
                <div class="card-header bg-light">
                  <h5 class="mb-0">Claim Information</h5>
                </div>
                <div class="card-body">
                  <p><strong>Claimed By:</strong> <%= item.finder.name %></p>
                  <p><strong>Claimed Date:</strong> <%= new Date(item.rewardRequestedAt).toLocaleDateString() %></p>
                  <p><strong>Payment Method:</strong> 
                    <span class="badge bg-info"><%= item.rewardPaymentMethod.toUpperCase() %></span>
                  </p>
                  
                  <% if (item.rewardPaymentMethod === 'upi' && item.rewardPaymentDetails.upiId) { %>
                    <p><strong>UPI ID:</strong> <%= item.rewardPaymentDetails.upiId %></p>
                  <% } %>
                  
                  <% if (item.rewardPaymentMethod === 'bank') { %>
                    <div class="mt-3">
                      <h6>Bank Details:</h6>
                      <p><strong>Bank:</strong> <%= item.rewardPaymentDetails.bankName %></p>
                      <p><strong>Account Number:</strong> <%= item.rewardPaymentDetails.accountNumber %></p>
                      <p><strong>Account Holder:</strong> <%= item.rewardPaymentDetails.accountHolderName %></p>
                      <p><strong>IFSC:</strong> <%= item.rewardPaymentDetails.ifscCode %></p>
                    </div>
                  <% } %>
                </div>
              </div>
            </div>
            
            <div class="col-md-6">
              <div class="card">
                <div class="card-header bg-light">
                  <h5 class="mb-0">Reward Details</h5>
                </div>
                <div class="card-body">
                  <h3 class="text-primary">Â£<%= item.reward %></h3>
                  
                  <% if (item.rewardPaymentStatus === 'requested') { %>
                    <div class="alert alert-warning">
                      <i class="fas fa-clock"></i> 
                      Reward claim is pending your approval.
                    </div>
                    
                    <form action="/items/<%= item._id %>/approve-reward" method="POST" class="mb-3">
                      <button type="submit" class="btn btn-success btn-lg w-100">
                        <i class="fas fa-check"></i> Approve Reward Payment
                      </button>
                    </form>
                    
                    <form action="/items/<%= item._id %>/reject-reward" method="POST">
                      <button type="submit" class="btn btn-danger w-100">
                        <i class="fas fa-times"></i> Reject Claim
                      </button>
                    </form>
                    
                  <% } else if (item.rewardPaymentStatus === 'approved') { %>
                    <div class="alert alert-info">
                      <i class="fas fa-check-circle"></i> 
                      Reward approved. Please send payment to the finder.
                    </div>
                    
                    <form action="/items/<%= item._id %>/mark-paid" method="POST">
                      <div class="mb-3">
                        <label class="form-label">Transaction Reference (Optional)</label>
                        <input type="text" class="form-control" name="transactionRef" placeholder="Transaction ID, UPI reference, etc.">
                      </div>
                      <button type="submit" class="btn btn-primary btn-lg w-100">
                        <i class="fas fa-paper-plane"></i> Mark as Paid
                      </button>
                    </form>
                    
                  <% } else if (item.rewardPaymentStatus === 'paid') { %>
                    <div class="alert alert-success">
                      <i class="fas fa-check-double"></i> 
                      Payment sent. Waiting for finder confirmation.
                    </div>
                    <p class="text-muted">Payment sent on: <%= new Date(item.rewardPaidAt).toLocaleDateString() %></p>
                    
                  <% } else if (item.rewardPaymentStatus === 'confirmed') { %>
                    <div class="alert alert-success">
                      <i class="fas fa-award"></i> 
                      Reward completed successfully!
                    </div>
                    <p><strong>Confirmed on:</strong> <%= new Date(item.rewardConfirmedAt).toLocaleDateString() %></p>
                  <% } %>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Action Buttons -->
          <div class="row">
            <div class="col-md-12">
              <div class="d-grid gap-2 d-md-flex justify-content-md-between">
                <a href="/items/<%= item._id %>" class="btn btn-secondary">
                  <i class="fas fa-arrow-left"></i> Back to Item
                </a>
                
                <% if (item.rewardPaymentStatus === 'paid') { %>
                  <a href="/items/<%= item._id %>/resend-verification" class="btn btn-warning">
                    <i class="fas fa-redo"></i> Resend Verification
                  </a>
                <% } %>
                
                <% if (item.rewardPaymentStatus === 'requested' || item.rewardPaymentStatus === 'approved') { %>
                  <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#cancelModal">
                    <i class="fas fa-ban"></i> Cancel Reward
                  </button>
                <% } %>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Cancel Modal -->
<div class="modal fade" id="cancelModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">Cancel Reward</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to cancel this reward? This action cannot be undone.</p>
        <form action="/items/<%= item._id %>/cancel-reward" method="POST" id="cancelForm">
          <div class="mb-3">
            <label class="form-label">Reason for cancellation</label>
            <textarea class="form-control" name="cancelReason" rows="3" required></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="submit" form="cancelForm" class="btn btn-danger">Cancel Reward</button>
      </div>
    </div>
  </div>
</div>

<style>
  .steps {
    display: flex;
    justify-content: space-between;
    position: relative;
    margin: 20px 0;
  }
  .steps::before {
    content: '';
    position: absolute;
    top: 20px;
    left: 0;
    right: 0;
    height: 3px;
    background: #e9ecef;
    z-index: 1;
  }
  .step {
    text-align: center;
    position: relative;
    z-index: 2;
  }
  .step-circle {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #e9ecef;
    color: #6c757d;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 10px;
    font-weight: bold;
  }
  .step.completed .step-circle {
    background: #198754;
    color: white;
  }
  .step-label {
    font-size: 0.85rem;
    color: #6c757d;
  }
  .step.completed .step-label {
    color: #198754;
    font-weight: bold;
  }
</style>